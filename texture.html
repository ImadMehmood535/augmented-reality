<!DOCTYPE html>
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>AR.js Video Playback with NFT Marker</title>
	<!-- include three.js library -->
	<script src='js/three.js'></script>
	<!-- include jsartoolkit -->
	<script src="jsartoolkit5/artoolkit.min.js"></script>
	<script src="jsartoolkit5/artoolkit.api.js"></script>
	<!-- include threex.artoolkit -->
	<script src="threex/threex-artoolkitsource.js"></script>
	<script src="threex/threex-artoolkitcontext.js"></script>
	<script src="threex/threex-arbasecontrols.js"></script>
	<script src="threex/threex-armarkercontrols.js"></script>
</head>

<body style='margin: 0px; overflow: hidden; font-family: Monospace;'>

<!-- Video Element -->
<video id="video" muted playsinline webkit-playsinline autoplay loop preload="auto" crossOrigin="anonymous" style="display:none">
    <source src="video/clicktap.mp4" type='video/mp4'>
    Your browser does not support the video tag.
</video>

<script>
var scene, camera, renderer, clock, deltaTime, totalTime;
var arToolkitSource, arToolkitContext;
var markerRoot1;
var mesh1;

initialize();
animate();

function initialize() {
    scene = new THREE.Scene();

    let ambientLight = new THREE.AmbientLight(0xcccccc, 0.5);
    scene.add(ambientLight);

    camera = new THREE.Camera();
    scene.add(camera);

    renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
    });
    renderer.setClearColor(new THREE.Color('lightgrey'), 0);
    renderer.setSize(640, 480);
    renderer.domElement.style.position = 'absolute';
    renderer.domElement.style.top = '0px';
    renderer.domElement.style.left = '0px';
    document.body.appendChild(renderer.domElement);

    clock = new THREE.Clock();
    deltaTime = 0;
    totalTime = 0;

    ////////////////////////////////////////////////////////////
    // setup arToolkitSource
    ////////////////////////////////////////////////////////////

    arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam',
    });

    function onResize() {
        arToolkitSource.onResize();
        arToolkitSource.copySizeTo(renderer.domElement);
        if (arToolkitContext.arController !== null) {
            arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
        }
    }

    arToolkitSource.init(function onReady() {
        onResize();
    });

    // handle resize event
    window.addEventListener('resize', function () {
        onResize();
    });

    ////////////////////////////////////////////////////////////
    // setup arToolkitContext
    ////////////////////////////////////////////////////////////

    // create arToolkitContext
    arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: 'data/camera_para.dat',
        detectionMode: 'mono'
    });

    // copy projection matrix to camera when initialization complete
    arToolkitContext.init(function onCompleted() {
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    ////////////////////////////////////////////////////////////
    // setup markerRoots
    ////////////////////////////////////////////////////////////

    // build markerControls with NFT marker type
    markerRoot1 = new THREE.Group();
    scene.add(markerRoot1);
    let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
        type: 'nft',
        descriptorsUrl: 'data/imageBased.iset',  // .fset, .fset3, .iset files
    });

    let geometry1 = new THREE.PlaneBufferGeometry(1, 1, 4, 4);
    let video = document.getElementById('video');
    let videoTexture = new THREE.VideoTexture(video);
    let material1 = new THREE.MeshBasicMaterial({ map: videoTexture });

    mesh1 = new THREE.Mesh(geometry1, material1);
    mesh1.rotation.x = -Math.PI / 2;

    markerRoot1.add(mesh1);

    // Try playing the video as soon as it's ready to be interacted with
    video.play().catch((e) => {
        console.log("Autoplay failed, retrying after user interaction.");
    });

    // If autoplay fails, play the video on the first user interaction
    document.body.addEventListener('click', () => {
        if (video.paused) {
            video.play().catch(e => console.error("Video play failed:", e));
        }
    });
}

function update() {
    // update artoolkit on every frame
    if (arToolkitSource.ready !== false)
        arToolkitContext.update(arToolkitSource.domElement);
}

function render() {
    renderer.render(scene, camera);
}

function animate() {
    requestAnimationFrame(animate);
    deltaTime = clock.getDelta();
    totalTime += deltaTime;
    update();
    render();
}

</script>

</body>
</html>
